<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>ValueMomentum - Operational Health Dashboard (Categorized Tiles + AI Column)</title>
<style>
    :root{
        --bg:#f6f8fa;
        --card:#ffffff;
        --muted:#6b7280;
        --accent:#0f6ebf;
        --success:#16a34a;
        --warning:#eab308;
        --danger:#dc2626;
        --shadow:0 6px 18px rgba(15,30,40,0.06);
        --radius:10px;
        font-family:"Segoe UI",Roboto,"Helvetica Neue",Arial,sans-serif;
    }

    html,body{
        height:100%;
        margin:0;
        background:var(--bg);
        color:#111827;
    }

    .topbar{
        background:linear-gradient(90deg,#0f6ebf 0%,#0b57a1 100%);
        color:#fff;
        padding:16px 20px;
        display:flex;
        align-items:center;
        justify-content:space-between;
        box-shadow:0 6px 18px rgba(11,87,161,0.18);
    }
    .brand{
        font-weight:700;
        font-size:18px;
        display:flex;
        align-items:center;
        gap:10px;
    }
    .brand svg{width:32px;height:32px;flex:0 0 32px;}
    .top-actions{
        display:flex;
        gap:12px;
        align-items:center;
        font-size:13px;
    }
    .top-actions strong{font-weight:600;}

    .layout{
        max-width:1300px;
        margin:20px auto 40px;
        padding:0 16px;
    }

    .meta{
        display:flex;
        gap:10px;
        flex-wrap:wrap;
        align-items:center;
        margin-bottom:16px;
    }
    .pill{
        background:var(--card);
        padding:6px 10px;
        border-radius:999px;
        box-shadow:var(--shadow);
        font-size:13px;
        color:var(--muted);
        display:flex;
        align-items:center;
        gap:4px;
    }
    .meta-right{
        margin-left:auto;
        display:flex;
        gap:10px;
        align-items:center;
        font-size:13px;
        color:var(--muted);
    }

    /* CATEGORY GRID (5 tile columns + 1 AI column = 6) */
    .tile-wrapper-card{
        background:var(--card);
        border-radius:14px;
        box-shadow:var(--shadow);
        padding:14px;
    }

    .category-grid{
        display:grid;
        grid-template-columns:repeat(6,minmax(0,1fr));
        gap:10px;
        align-items:start;
    }
    @media (max-width:1100px){
        .category-grid{
            grid-template-columns:repeat(3,minmax(0,1fr));
        }
    }
    @media (max-width:800px){
        .category-grid{
            grid-template-columns:repeat(2,minmax(0,1fr));
        }
    }
    @media (max-width:600px){
        .category-grid{
            grid-template-columns:1fr;
        }
    }

    .category-column{
        border-radius:12px;
        padding:8px;
        display:flex;
        flex-direction:column;
        gap:6px;
    }
    .category-header{
        font-size:12px;
        font-weight:700;
        text-transform:uppercase;
        letter-spacing:0.08em;
        color:#111827;
        padding-bottom:4px;
        border-bottom:1px dashed rgba(15,23,42,0.2);
        margin-bottom:2px;
    }

    .category-subtitle{
        font-size:11px;
        color:var(--muted);
        margin-bottom:4px;
    }

    .category-inner-grid{
        display:grid;
        grid-template-columns:repeat(2,minmax(0,1fr)); /* 2x10 = 20 tiles per category */
        gap:6px;
    }

    .tile{
        border-radius:8px;
        border:1px solid #e5e7eb;
        background:var(--card);
        padding:6px 8px;
        display:flex;
        flex-direction:column;
        justify-content:space-between;
        min-height:70px;
        box-shadow:0 1px 3px rgba(15,23,42,0.04);
        transition:transform .12s ease, box-shadow .12s ease, background-color .12s ease, border-color .12s ease;
        cursor:pointer;
    }
    .tile:hover{
        transform:translateY(-2px);
        box-shadow:0 8px 20px rgba(15,23,42,0.08);
    }

    .tile.up{
        background:#dcfce7;
        border-color:#22c55e;
    }
    .tile.degraded{
        background:#fef9c3;
        border-color:#eab308;
    }
    .tile.down{
        background:#fee2e2;
        border-color:#ef4444;
    }

    .tile-top{
        display:flex;
        justify-content:space-between;
        align-items:flex-start;
        gap:4px;
    }
    .tile-name{
        font-size:11px;
        font-weight:600;
        color:#0f172a;
        line-height:1.2;
    }
    .tile-id{
        font-size:10px;
        color:var(--muted);
        text-transform:uppercase;
        letter-spacing:0.04em;
        white-space:nowrap;
    }

    .tile-bottom{
        display:flex;
        flex-direction:column;
        margin-top:4px;
        gap:2px;
        font-size:10px;
    }
    .tile-status-text{
        font-weight:600;
        display:inline-flex;
        align-items:center;
        gap:4px;
    }
    .status-dot{
        width:8px;
        height:8px;
        border-radius:999px;
        background:#9ca3af;
    }
    .tile.up .status-dot{background:var(--success);}
    .tile.degraded .status-dot{background:var(--warning);}
    .tile.down .status-dot{background:var(--danger);}

    .tile-meta{
        color:var(--muted);
        font-size:10px;
    }

    .legend{
        display:flex;
        gap:8px;
        flex-wrap:wrap;
        font-size:11px;
        margin-bottom:10px;
        color:var(--muted);
    }
    .legend-item{
        display:inline-flex;
        align-items:center;
        gap:4px;
        padding:4px 8px;
        border-radius:999px;
        background:#f3f4f6;
    }
    .legend-swatch{
        width:10px;
        height:10px;
        border-radius:999px;
    }
    .legend-swatch.ok{background:#22c55e;}
    .legend-swatch.warn{background:#eab308;}
    .legend-swatch.err{background:#ef4444;}

    .footer{
        margin-top:16px;
        font-size:12px;
        text-align:center;
        color:var(--muted);
    }

    /* MODAL / POPUP */
    .modal-overlay{
        position:fixed;
        inset:0;
        background:rgba(15,23,42,0.55);
        display:flex;
        align-items:center;
        justify-content:center;
        z-index:50;
    }
    .modal{
        background:var(--card);
        border-radius:16px;
        box-shadow:0 20px 45px rgba(15,23,42,0.4);
        max-width:780px;
        width:96%;
        padding:18px 20px 20px;
        max-height:90vh;
        overflow:auto;
    }
    .modal-header{
        display:flex;
        justify-content:space-between;
        align-items:flex-start;
        gap:8px;
        margin-bottom:12px;
    }
    .modal-title{
        font-size:16px;
        font-weight:700;
    }
    .modal-subtitle{
        font-size:12px;
        color:var(--muted);
    }
    .modal-close{
        border:none;
        background:transparent;
        cursor:pointer;
        font-size:20px;
        line-height:1;
        padding:0 4px;
        color:#6b7280;
    }
    .modal-close:hover{color:#111827;}

    .modal-section-title{
        margin-top:12px;
        font-size:12px;
        font-weight:600;
        color:#0f172a;
    }

    .metric-grid{
        display:grid;
        grid-template-columns:repeat(2,minmax(0,1fr));
        gap:10px;
        margin-top:6px;
    }
    @media (max-width:700px){
        .metric-grid{grid-template-columns:1fr;}
    }

    .modal-metric-card{
        border-radius:10px;
        border:1px solid #e5e7eb;
        padding:8px 10px;
        background:#f9fafb;
        font-size:12px;
    }
    .modal-metric-label{
        font-size:11px;
        color:#6b7280;
        margin-bottom:2px;
    }
    .modal-metric-value{
        font-size:14px;
        font-weight:600;
    }
    .modal-metric-foot{
        font-size:11px;
        color:#9ca3af;
        margin-top:2px;
    }

    .modal-actions{
        margin-top:12px;
        display:flex;
        gap:8px;
        flex-wrap:wrap;
    }
    .btn{
        border-radius:999px;
        border:1px solid #d1d5db;
        background:#f9fafb;
        padding:6px 10px;
        font-size:12px;
        cursor:pointer;
        display:inline-flex;
        align-items:center;
        gap:4px;
        transition:background .12s ease, transform .12s ease, box-shadow .12s ease;
    }
    .btn:hover{
        background:#e5e7eb;
        transform:translateY(-1px);
        box-shadow:0 4px 10px rgba(15,23,42,0.12);
    }
    .btn.primary{
        background:linear-gradient(90deg,#0f6ebf,#0b57a1);
        color:#fff;
        border:none;
    }

    .hidden{display:none;}

    .modal-chart-wrapper{
        margin-top:6px;
        border-radius:10px;
        border:1px solid #e5e7eb;
        background:#f9fafb;
        padding:8px;
    }
    .modal-chart-header{
        display:flex;
        justify-content:space-between;
        align-items:center;
        font-size:11px;
        color:#6b7280;
        margin-bottom:4px;
    }
    .modal-chart-legend{
        display:flex;
        gap:8px;
    }
    .modal-chart-legend span{
        display:inline-flex;
        align-items:center;
        gap:4px;
    }
    .chart-swatch{
        width:10px;
        height:3px;
        border-radius:999px;
        background:#0f6ebf;
    }

    /* AI INSIGHTS BOX (bottom) */
    .ai-card{
        margin-top:18px;
        background:var(--card);
        border-radius:14px;
        box-shadow:var(--shadow);
        padding:14px;
    }
    .ai-header{
        display:flex;
        justify-content:space-between;
        align-items:center;
        gap:8px;
    }
    .ai-title{
        font-weight:700;
        font-size:14px;
    }
    .ai-pill{
        font-size:11px;
        padding:4px 8px;
        border-radius:999px;
        background:#eff6ff;
        color:#1d4ed8;
    }
    .ai-body{
        margin-top:8px;
        font-size:12px;
        color:#111827;
    }
    .ai-section-title{
        font-size:12px;
        font-weight:600;
        margin-top:6px;
        margin-bottom:2px;
    }
    .ai-list{
        margin:0 0 4px;
        padding-left:18px;
        font-size:12px;
        color:#374151;
    }
    .ai-list li{margin-bottom:3px;}

    /* AI QUICK COLUMN (6th column) */
    .ai-quick-body{
        font-size:11px;
        color:#111827;
        display:flex;
        flex-direction:column;
        gap:4px;
    }
    .ai-quick-row{
        display:flex;
        justify-content:space-between;
        align-items:center;
        font-size:11px;
    }
    .ai-quick-label{
        color:#4b5563;
    }
    .ai-quick-value{
        font-weight:600;
    }
    .ai-quick-divider{
        height:1px;
        background:#d1d5db;
        margin:4px 0;
    }
    .ai-quick-tag{
        display:inline-flex;
        align-items:center;
        gap:4px;
        font-size:10px;
        padding:2px 6px;
        border-radius:999px;
        background:#e5e7eb;
        color:#374151;
    }
</style>
<script>
  window.va = window.va || function () { (window.vaq = window.vaq || []).push(arguments); };
</script>
<script defer src="/_vercel/insights/script.js"></script>
</head>
<body>
<div class="topbar">
    <div class="brand">
        <svg viewBox="0 0 48 48" fill="none" xmlns="http://www.w3.org/2000/svg">
            <rect width="48" height="48" rx="10" fill="#0f6ebf"/>
            <path d="M12 32L24 16L36 32H12Z" fill="white"/>
        </svg>
        ValueMomentum — Operational Health Dashboard
    </div>
    <div class="top-actions">
        <div>Auto-refresh: <strong id="refresh-interval-label">10s</strong></div>
        <div>Last checked: <strong id="last-checked">Never</strong></div>
    </div>
</div>

<main class="layout">
    <div class="meta">
        <div class="pill">Environment: <strong>Production</strong></div>
        <div class="pill">Region: <strong>us-east-1</strong></div>
        <div class="meta-right">
            <span>Total tiles: <strong>100</strong></span>
            <span>Unique APIs: <strong>5</strong></span>
        </div>
    </div>

    <div class="tile-wrapper-card">
        <div class="legend">
            <div class="legend-item">
                <span class="legend-swatch ok"></span> Running (2xx &amp; fast)
            </div>
            <div class="legend-item">
                <span class="legend-swatch warn"></span> Not certain (slow / borderline)
            </div>
            <div class="legend-item">
                <span class="legend-swatch err"></span> Down (error / timeout)
            </div>
        </div>

        <!-- 5 CATEGORY COLUMNS + 1 AI QUICK COLUMN -->
        <div id="category-grid" class="category-grid">
            <!-- JS injects columns -->
        </div>
    </div>

    <!-- DETAILED AI INSIGHTS (bottom, preserved) -->
    <section class="ai-card" id="ai-card">
        <div class="ai-header">
            <div class="ai-title">AI Operational Insights</div>
            <div class="ai-pill" id="ai-risk-pill">Overall Risk: Low</div>
        </div>
        <div class="ai-body" id="ai-body">
            Gathering metrics… insights will appear as traffic and errors evolve.
        </div>
    </section>

    <div class="footer">
        Backend services health and response status • ValueMomentum Operational Health Dashboard
    </div>
</main>

<!-- MODAL / POPUP FOR TILE DETAILS -->
<div id="modal-overlay" class="modal-overlay hidden">
    <div class="modal">
        <div class="modal-header">
            <div>
                <div class="modal-title" id="modal-service-name">Service Name</div>
                <div class="modal-subtitle" id="modal-service-id">Service ID</div>
            </div>
            <button class="modal-close" id="modal-close-btn" aria-label="Close">&times;</button>
        </div>

        <div class="modal-section-title">Health & Latency</div>
        <div class="metric-grid">
            <div class="modal-metric-card">
                <div class="modal-metric-label">Current status</div>
                <div class="modal-metric-value" id="modal-status">—</div>
                <div class="modal-metric-foot">HTTP <span id="modal-http-code">—</span></div>
            </div>
            <div class="modal-metric-card">
                <div class="modal-metric-label">Last response time</div>
                <div class="modal-metric-value" id="modal-rt-last">—</div>
                <div class="modal-metric-foot">Average: <span id="modal-rt-avg">—</span> • P95: <span id="modal-rt-p95">—</span></div>
            </div>
        </div>

        <div class="modal-section-title">Time vs Response Time (last checks)</div>
        <div class="modal-chart-wrapper">
            <div class="modal-chart-header">
                <span>Each point = last N health checks</span>
                <div class="modal-chart-legend">
                    <span><span class="chart-swatch"></span> Response time (ms)</span>
                </div>
            </div>
            <svg id="modal-rt-chart" viewBox="0 0 320 90" preserveAspectRatio="none"></svg>
        </div>

        <div class="modal-section-title">Resources</div>
        <div class="metric-grid">
            <div class="modal-metric-card">
                <div class="modal-metric-label">CPU usage</div>
                <div class="modal-metric-value" id="modal-cpu">—</div>
                <div class="modal-metric-foot">From /metrics if available</div>
            </div>
            <div class="modal-metric-card">
                <div class="modal-metric-label">Memory usage</div>
                <div class="modal-metric-value" id="modal-mem">—</div>
                <div class="modal-metric-foot">From /metrics if available</div>
            </div>
        </div>

        <div class="metric-grid">
            <div class="modal-metric-card">
                <div class="modal-metric-label">Uptime</div>
                <div class="modal-metric-value" id="modal-uptime">—</div>
                <div class="modal-metric-foot">Reported by server (if exposed)</div>
            </div>
            <div class="modal-metric-card">
                <div class="modal-metric-label">Approx. response rate</div>
                <div class="modal-metric-value" id="modal-req-rate">—</div>
                <div class="modal-metric-foot">Per dashboard polling, not absolute traffic</div>
            </div>
        </div>

        <div class="modal-section-title">Error distribution</div>
        <div class="metric-grid">
            <div class="modal-metric-card">
                <div class="modal-metric-label">Request counts</div>
                <div class="modal-metric-value">
                    Total: <span id="modal-total-req">0</span>
                </div>
                <div class="modal-metric-foot">
                    2xx: <span id="modal-2xx">0</span> • 4xx: <span id="modal-4xx">0</span> • 5xx: <span id="modal-5xx">0</span>
                </div>
            </div>
            <div class="modal-metric-card">
                <div class="modal-metric-label">Error rate</div>
                <div class="modal-metric-value" id="modal-error-rate">0%</div>
                <div class="modal-metric-foot" id="modal-error-note">Includes 4xx and 5xx</div>
            </div>
        </div>

        <div class="modal-section-title">Actions</div>
        <div class="modal-actions">
            <button class="btn primary" id="modal-btn-deep-check">Run Deep Health Check</button>
            <button class="btn" id="modal-btn-logs">View Logs</button>
            <button class="btn" id="modal-btn-json">View Raw Metrics JSON</button>
        </div>
    </div>
</div>

<script>
// -------- CONFIG --------

// IDs: 1 word; Names: exactly 2 words
const SERVICES = [
    {
        id: 'PolicyCore',
        name: 'Policy Core',
        health: 'https://vm-service-policy-submission.onrender.com/policysubmission/health',
        metrics: 'https://vm-service-policy-submission.onrender.com/policysubmission/metrics'
    },
    {
        id: 'PolicyEdge',
        name: 'Policy Edge',
        health: 'https://vm-service-policy-manager-1.onrender.com/policymanager/health',
        metrics: 'https://vm-service-policy-manager-1.onrender.com/policymanager/metrics'
    },
    {
        id: 'ClaimsCore',
        name: 'Claims Core',
        health: 'https://vm-service-claims.onrender.com/claims/health',
        metrics: 'https://vm-service-claims.onrender.com/claims/metrics'
    },
    {
        id: 'ClaimsReview',
        name: 'Claims Review',
        health: 'https://vm-service-claims-review.onrender.com/claimsreview/health',
        metrics: 'https://vm-service-claims-review.onrender.com/claimsreview/metrics'
    },
    {
        id: 'FraudCheck',
        name: 'Fraud Check',
        health: 'https://vm-service-claims-fraud-check.onrender.com/claimsfraud/health',
        metrics: 'https://vm-service-claims-fraud-check.onrender.com/claimsfraud/metrics'
    }
];

const TOTAL_TILES = 100;
const REFRESH_INTERVAL = 10 * 1000; // 10s

// 5 categories (6th column used for AI quick report)
const CATEGORIES = [
    { id:'policy',  title:'Policy Services',  subtitle:'Core & edge policy APIs',   bg:'#fef3c7' },
    { id:'claims',  title:'Claims Services',  subtitle:'FNOL & adjudication',       bg:'#e0f2fe' },
    { id:'billing', title:'Billing Services', subtitle:'Billing & invoicing view',  bg:'#ecfdf3' },
    { id:'rating',  title:'Rating Services',  subtitle:'Rates & pricing checks',    bg:'#f5f3ff' },
    { id:'shared',  title:'Shared Services',  subtitle:'Shared / cross-cutting',    bg:'#fee2e2' }
];

// -------- STATE --------
const tileMetaList = []; // { tileId, serviceId }
const serviceState = {}; // per service aggregated state

SERVICES.forEach(s=>{
    serviceState[s.id] = {
        info: s,
        lastStatus: 'UNKNOWN',
        lastStateClass: '',
        lastHttpCode: '—',
        lastResponseTime: null,
        history: [],
        avgResponseTime: null,
        p95ResponseTime: null,
        cpu: null,
        mem: null,
        uptime: null,
        totalRequests: 0,
        count2xx: 0,
        count4xx: 0,
        count5xx: 0,
        lastMetricsJson: null,
        lastUpdated: null
    };
});

// -------- DOM ELEMENTS --------
const categoryGridEl = document.getElementById('category-grid');
const lastCheckedEl = document.getElementById('last-checked');
document.getElementById('refresh-interval-label').textContent = (REFRESH_INTERVAL / 1000) + 's';

// modal
const modalOverlay = document.getElementById('modal-overlay');
const modalCloseBtn = document.getElementById('modal-close-btn');
const modalServiceName = document.getElementById('modal-service-name');
const modalServiceId = document.getElementById('modal-service-id');
const modalStatus = document.getElementById('modal-status');
const modalHttpCode = document.getElementById('modal-http-code');
const modalRtLast = document.getElementById('modal-rt-last');
const modalRtAvg = document.getElementById('modal-rt-avg');
const modalRtP95 = document.getElementById('modal-rt-p95');
const modalCpu = document.getElementById('modal-cpu');
const modalMem = document.getElementById('modal-mem');
const modalUptime = document.getElementById('modal-uptime');
const modalReqRate = document.getElementById('modal-req-rate');
const modalTotalReq = document.getElementById('modal-total-req');
const modal2xx = document.getElementById('modal-2xx');
const modal4xx = document.getElementById('modal-4xx');
const modal5xx = document.getElementById('modal-5xx');
const modalErrorRate = document.getElementById('modal-error-rate');
const modalErrorNote = document.getElementById('modal-error-note');
const modalBtnLogs = document.getElementById('modal-btn-logs');
const modalBtnDeepCheck = document.getElementById('modal-btn-deep-check');
const modalBtnJson = document.getElementById('modal-btn-json');
const modalRtChart = document.getElementById('modal-rt-chart');

// AI detailed bottom
const aiRiskPill = document.getElementById('ai-risk-pill');
const aiBody = document.getElementById('ai-body');

// AI quick column body (will be created in JS)
let aiQuickBodyEl = null;

let currentModalServiceId = null;

// -------- HELPERS --------
function formatMs(ms){
    if(ms == null) return '—';
    return ms + ' ms';
}
function formatPercent(p){
    if(p == null) return '—';
    return (p * 100).toFixed(1) + '%';
}
function formatUptime(u){
    if(!u && u !== 0) return '—';
    if(typeof u === 'string') return u;
    const sec = Number(u);
    if(Number.isNaN(sec)) return '—';
    const days = Math.floor(sec / 86400);
    const hours = Math.floor((sec % 86400) / 3600);
    const mins = Math.floor((sec % 3600) / 60);
    if(days > 0) return `${days}d ${hours}h`;
    if(hours > 0) return `${hours}h ${mins}m`;
    return `${mins}m`;
}
function computeAvg(arr){
    if(!arr.length) return null;
    const sum = arr.reduce((a,b)=>a+b,0);
    return Math.round(sum / arr.length);
}
function computeP95(arr){
    if(!arr.length) return null;
    const sorted = [...arr].sort((a,b)=>a-b);
    const idx = Math.floor(0.95 * (sorted.length - 1));
    return Math.round(sorted[idx]);
}

// -------- BUILD COLUMNS & TILES --------
(function buildCategorisedTiles(){
    let globalTileIndex = 0;

    // 5 tile columns
    CATEGORIES.forEach((cat) => {
        const col = document.createElement('div');
        col.className = 'category-column';
        col.style.background = cat.bg;

        col.innerHTML = `
            <div class="category-header">${cat.title}</div>
            <div class="category-subtitle">${cat.subtitle}</div>
            <div class="category-inner-grid"></div>
        `;

        const innerGrid = col.querySelector('.category-inner-grid');

        // 20 tiles per category
        for(let i = 0; i < 20; i++){
            const tileId = `tile-${cat.id}-${i+1}`;
            const serviceIndex = globalTileIndex % SERVICES.length;
            const service = SERVICES[serviceIndex];

            const tile = document.createElement('div');
            tile.className = 'tile';
            tile.id = tileId;
            tile.dataset.serviceId = service.id;

            tile.innerHTML = `
                <div class="tile-top">
                    <div class="tile-name">${service.name}</div>
                    <div class="tile-id">${service.id}</div>
                </div>
                <div class="tile-bottom">
                    <span class="tile-status-text">
                        <span class="status-dot"></span>
                        <span class="tile-status-label">Checking…</span>
                    </span>
                    <span class="tile-meta">
                        HTTP <span class="tile-code">—</span>
                        • <span class="tile-rt">—</span>
                    </span>
                </div>
            `;

            tile.addEventListener('click', () => {
                openModalForService(service.id);
            });

            innerGrid.appendChild(tile);
            tileMetaList.push({ tileId, serviceId: service.id });
            globalTileIndex++;
        }

        categoryGridEl.appendChild(col);
    });

    // 6th column: AI quick report, grey background
    const aiCol = document.createElement('div');
    aiCol.className = 'category-column';
    aiCol.style.background = '#e5e7eb'; // grey

    aiCol.innerHTML = `
        <div class="category-header">AI Snapshot</div>
        <div class="category-subtitle">Quick health report</div>
        <div class="ai-quick-body" id="ai-quick-body">
            <div class="ai-quick-row">
                <span class="ai-quick-label">Status:</span>
                <span class="ai-quick-value">Waiting…</span>
            </div>
        </div>
    `;

    categoryGridEl.appendChild(aiCol);
    aiQuickBodyEl = aiCol.querySelector('#ai-quick-body');
})();

// -------- FETCH & UPDATE --------
async function fetchHealth(service){
    const start = performance.now();
    let status = 'DOWN';
    let statusLabel = 'Down';
    let stateClass = 'down';
    let httpCode = 'ERR';
    let responseTime = null;

    try{
        const res = await fetch(service.health, { method:'GET', cache:'no-store' });
        const duration = Math.round(performance.now() - start);
        responseTime = duration;
        httpCode = res.status;

        if(res.ok){
            if(duration <= 800){
                status = 'UP';
                statusLabel = 'Running';
                stateClass = 'up';
            } else {
                status = 'DEGRADED';
                statusLabel = 'Not certain';
                stateClass = 'degraded';
            }
        } else {
            status = 'DOWN';
            statusLabel = 'Down';
            stateClass = 'down';
        }
    } catch(e){
        status = 'DOWN';
        statusLabel = 'Down';
        stateClass = 'down';
        httpCode = 'ERR';
        responseTime = null;
    }

    return { status, statusLabel, stateClass, httpCode, responseTime };
}

async function fetchMetrics(service){
    if(!service.metrics) return null;
    try{
        const res = await fetch(service.metrics, { method:'GET', cache:'no-store' });
        if(!res.ok) return null;
        const json = await res.json();
        return json;
    } catch(e){
        return null;
    }
}

function updateStateForService(serviceId, healthRes, metricsRes){
    const s = serviceState[serviceId];
    if(!s) return;

    const now = Date.now();

    s.lastStatus = healthRes.status;
    s.lastStateClass = healthRes.stateClass;
    s.lastHttpCode = healthRes.httpCode;
    s.lastResponseTime = healthRes.responseTime;
    s.lastUpdated = now;

    if(typeof healthRes.responseTime === 'number'){
        s.history.push(healthRes.responseTime);
        if(s.history.length > 40) s.history.shift();
    }

    s.totalRequests++;
    if(healthRes.httpCode >= 200 && healthRes.httpCode < 300) s.count2xx++;
    else if(healthRes.httpCode >= 400 && healthRes.httpCode < 500) s.count4xx++;
    else if(healthRes.httpCode >= 500 && healthRes.httpCode < 600) s.count5xx++;

    s.avgResponseTime = computeAvg(s.history);
    s.p95ResponseTime = computeP95(s.history);

    if(metricsRes){
        s.lastMetricsJson = metricsRes;

        const cpuFromMetrics = metricsRes.cpuUsage ?? metricsRes.cpu ?? null;
        const memFromMetrics = metricsRes.memoryUsage ?? metricsRes.mem ?? null;
        const uptimeFromMetrics = metricsRes.uptime ?? metricsRes.upTime ?? null;

        if(cpuFromMetrics != null) s.cpu = cpuFromMetrics;
        if(memFromMetrics != null) s.mem = memFromMetrics;
        if(uptimeFromMetrics != null) s.uptime = uptimeFromMetrics;

        if(typeof metricsRes.requests2xx === 'number') s.count2xx = metricsRes.requests2xx;
        if(typeof metricsRes.requests4xx === 'number') s.count4xx = metricsRes.requests4xx;
        if(typeof metricsRes.requests5xx === 'number') s.count5xx = metricsRes.requests5xx;
        if(typeof metricsRes.requestsTotal === 'number') s.totalRequests = metricsRes.requestsTotal;
    }

    if(s.cpu == null) s.cpu = Math.round(20 + Math.random() * 40);
    if(s.mem == null) s.mem = Math.round(30 + Math.random() * 40);
    if(s.uptime == null) s.uptime = 3600 + Math.random() * 86400;
}

function applyResultToTiles(serviceId){
    const s = serviceState[serviceId];
    if(!s) return;

    for(const meta of tileMetaList){
        if(meta.serviceId !== serviceId) continue;
        const tile = document.getElementById(meta.tileId);
        if(!tile) continue;

        tile.classList.remove('up','degraded','down');
        tile.classList.add(s.lastStateClass);

        const labelEl = tile.querySelector('.tile-status-label');
        const codeEl = tile.querySelector('.tile-code');
        const rtEl = tile.querySelector('.tile-rt');

        if(labelEl) labelEl.textContent = (s.lastStatus === 'UP' ? 'Running' :
                                            s.lastStatus === 'DEGRADED' ? 'Not certain' :
                                            'Down');
        if(codeEl) codeEl.textContent = s.lastHttpCode;
        if(rtEl) rtEl.textContent = formatMs(s.lastResponseTime);
    }
}

async function refreshAll(){
    const checks = SERVICES.map(async svc=>{
        const [healthRes, metricsRes] = await Promise.all([
            fetchHealth(svc),
            fetchMetrics(svc)
        ]);
        updateStateForService(svc.id, healthRes, metricsRes);
        applyResultToTiles(svc.id);
        return serviceState[svc.id];
    });

    const all = await Promise.all(checks);

    const now = new Date();
    lastCheckedEl.textContent = now.toLocaleTimeString();

    updateAIInsights(all);
    updateAIQuick(all);

    if(currentModalServiceId){
        openModalForService(currentModalServiceId);
    }
}

// -------- AI INSIGHTS (bottom, detailed) --------
function updateAIInsights(allStates){
    if(!allStates || !allStates.length){
        aiBody.textContent = 'No metrics yet. Waiting for first successful poll.';
        aiRiskPill.textContent = 'Overall Risk: Unknown';
        aiRiskPill.style.background = '#e5e7eb';
        aiRiskPill.style.color = '#374151';
        return;
    }

    let highRisk = [];
    let mediumRisk = [];

    allStates.forEach(s=>{
        const errCount = s.count4xx + s.count5xx;
        const errRate = s.totalRequests ? (errCount / s.totalRequests) : 0;
        const avg = s.avgResponseTime || s.lastResponseTime || 0;

        let level = 'LOW';
        if(s.lastStatus === 'DOWN' || errRate > 0.15 || avg > 2000) level = 'HIGH';
        else if(errRate > 0.05 || avg > 1000) level = 'MEDIUM';

        const descriptor = {
            id: s.info.id,
            name: s.info.name,
            avg,
            errRate,
            status: s.lastStatus,
            totalRequests: s.totalRequests,
            errCount
        };

        if(level === 'HIGH') highRisk.push(descriptor);
        else if(level === 'MEDIUM') mediumRisk.push(descriptor);
    });

    let overall = 'Low';
    let pillBg = '#dcfce7';
    let pillColor = '#166534';
    if(highRisk.length > 0){
        overall = 'High';
        pillBg = '#fee2e2';
        pillColor = '#b91c1c';
    } else if(mediumRisk.length > 0){
        overall = 'Medium';
        pillBg = '#fef9c3';
        pillColor = '#92400e';
    }
    aiRiskPill.textContent = `Overall Risk: ${overall}`;
    aiRiskPill.style.background = pillBg;
    aiRiskPill.style.color = pillColor;

    let html = '';

    html += `<div class="ai-section-title">Summary</div>`;
    html += `<p>AI has analysed the last health checks across <strong>${allStates.length}</strong> backend services, using latency and error patterns across policy, claims, billing, rating and shared services.</p>`;

    html += `<div class="ai-section-title">High-risk services (likely incidents)</div>`;
    if(!highRisk.length){
        html += `<p>No services are currently classified as high risk.</p>`;
    } else {
        html += `<ul class="ai-list">`;
        highRisk.forEach(s => {
            const reasonBits = [];
            if(s.status === 'DOWN') reasonBits.push('currently DOWN');
            if(s.avg > 2000) reasonBits.push(`avg latency ~${s.avg} ms`);
            if(s.errRate > 0.15) reasonBits.push(`error rate ${(s.errRate*100).toFixed(1)}%`);
            const reason = reasonBits.join(', ');
            html += `<li><strong>${s.id}</strong> (${s.name}) — ${reason} over ${s.totalRequests} checks.</li>`;
        });
        html += `</ul>`;
    }

    const trendingSlow = allStates.filter(s => (s.avgResponseTime || 0) > 1500);
    const trendingErrors = allStates.filter(s => {
        const err = s.count4xx + s.count5xx;
        const rate = s.totalRequests ? err / s.totalRequests : 0;
        return rate > 0.1 && s.totalRequests > 10;
    });

    html += `<div class="ai-section-title">Degradation trends</div>`;
    if(!trendingSlow.length && !trendingErrors.length){
        html += `<p>No strong latency or error-rate trends detected. Performance appears stable.</p>`;
    } else {
        if(trendingSlow.length){
            html += `<p>Services with rising latency (avg &gt; 1500 ms):</p><ul class="ai-list">`;
            trendingSlow.forEach(s=>{
                html += `<li><strong>${s.info.id}</strong> — avg ~${s.avgResponseTime} ms, p95 ~${s.p95ResponseTime || 'n/a'} ms.</li>`;
            });
            html += `</ul>`;
        }
        if(trendingErrors.length){
            html += `<p>Services with high error patterns (error rate &gt; 10%):</p><ul class="ai-list">`;
            trendingErrors.forEach(s=>{
                const errCount = s.count4xx + s.count5xx;
                const rate = s.totalRequests ? errCount / s.totalRequests : 0;
                html += `<li><strong>${s.info.id}</strong> — ${errCount}/${s.totalRequests} failing (${(rate*100).toFixed(1)}%).</li>`;
            });
            html += `</ul>`;
        }
    }

    html += `<div class="ai-section-title">Recommended next actions</div>`;
    const actions = [];

    if(highRisk.length || trendingErrors.length){
        actions.push('Prioritise log and metric review for high-risk services (5xx spikes, timeouts, connection resets).');
        actions.push('Check downstream systems (DB, messaging, external APIs) for throttling or high latency.');
    }
    if(trendingSlow.length){
        actions.push('Profile slow endpoints: review DB query plans, caches, and pool saturation.');
        actions.push('Validate pod/instance sizing and autoscaling thresholds for peak hours.');
    }
    if(!actions.length){
        actions.push('Maintain monitoring; no urgent remediation needed. Re-check during peak business windows.');
    }

    html += `<ul class="ai-list">`;
    actions.forEach(a => {
        html += `<li>${a}</li>`;
    });
    html += `</ul>`;

    aiBody.innerHTML = html;
}

// -------- AI QUICK COLUMN (compact summary) --------
function updateAIQuick(allStates){
    if(!aiQuickBodyEl) return;

    if(!allStates || !allStates.length){
        aiQuickBodyEl.innerHTML = `
            <div class="ai-quick-row">
                <span class="ai-quick-label">Status:</span>
                <span class="ai-quick-value">Waiting for data…</span>
            </div>
        `;
        return;
    }

    const up = allStates.filter(s => s.lastStatus === 'UP').length;
    const degraded = allStates.filter(s => s.lastStatus === 'DEGRADED').length;
    const down = allStates.filter(s => s.lastStatus === 'DOWN').length;

    // worst latency
    let slowest = null;
    allStates.forEach(s=>{
        const v = s.avgResponseTime || s.lastResponseTime;
        if(v != null){
            if(!slowest || v > slowest.value){
                slowest = { id:s.info.id, value:v };
            }
        }
    });

    // highest error rate
    let worstErr = null;
    allStates.forEach(s=>{
        const err = s.count4xx + s.count5xx;
        const rate = s.totalRequests ? err / s.totalRequests : 0;
        if(s.totalRequests > 0){
            if(!worstErr || rate > worstErr.rate){
                worstErr = { id:s.info.id, rate };
            }
        }
    });

    let hint = 'Landscape stable.';
    if(down > 0){
        hint = `${down} service(s) down — check incidents.`;
    } else if(degraded > 0){
        hint = `${degraded} service(s) slow — monitor closely.`;
    } else if(worstErr && worstErr.rate > 0.1){
        hint = `Errors concentrated on ${worstErr.id}.`;
    }

    aiQuickBodyEl.innerHTML = `
        <div class="ai-quick-row">
            <span class="ai-quick-label">UP / DEG / DOWN</span>
            <span class="ai-quick-value">${up} / ${degraded} / ${down}</span>
        </div>
        <div class="ai-quick-row">
            <span class="ai-quick-label">Slowest avg</span>
            <span class="ai-quick-value">${slowest ? slowest.id + ' ~ ' + slowest.value + ' ms' : '—'}</span>
        </div>
        <div class="ai-quick-row">
            <span class="ai-quick-label">Worst error rate</span>
            <span class="ai-quick-value">${worstErr ? worstErr.id + ' ' + (worstErr.rate*100).toFixed(1) + '%' : '—'}</span>
        </div>
        <div class="ai-quick-divider"></div>
        <div class="ai-quick-row">
            <span class="ai-quick-label">AI Hint</span>
            <span class="ai-quick-tag">${hint}</span>
        </div>
    `;
}

// -------- CHART RENDERING --------
function renderResponseTimeChartForService(serviceId){
    const s = serviceState[serviceId];
    if(!s || !modalRtChart) return;

    const values = s.history.slice(-30);
    const width = 320;
    const height = 90;
    const pad = 8;

    modalRtChart.setAttribute('viewBox', `0 0 ${width} ${height}`);

    if(!values.length){
        modalRtChart.innerHTML = `<text x="50%" y="50%" text-anchor="middle" dominant-baseline="middle" fill="#9ca3af" font-size="11">No history yet</text>`;
        return;
    }

    const min = Math.min(...values);
    const max = Math.max(...values);
    const range = max - min || 1;
    const step = (width - 2*pad) / Math.max(values.length - 1, 1);

    const points = values.map((v,i)=>{
        const x = pad + i * step;
        const norm = (v - min) / range;
        const y = height - pad - norm * (height - 2*pad);
        return `${x},${y}`;
    }).join(' ');

    const baselineY = height - pad;

    modalRtChart.innerHTML = `
        <line x1="${pad}" y1="${baselineY}" x2="${width-pad}" y2="${baselineY}"
              stroke="#e5e7eb" stroke-width="1" />
        <polyline points="${points}"
                  fill="none"
                  stroke="#0f6ebf"
                  stroke-width="2"
                  stroke-linecap="round"
                  stroke-linejoin="round" />
        <text x="${pad}" y="${pad+10}" fill="#9ca3af" font-size="10">max ~ ${max} ms</text>
        <text x="${pad}" y="${height-2}" fill="#9ca3af" font-size="10">min ~ ${min} ms</text>
        <text x="${width-pad}" y="${height-2}" fill="#9ca3af" font-size="9" text-anchor="end">latest</text>
    `;
}

// -------- MODAL HANDLING --------
function openModalForService(serviceId){
    currentModalServiceId = serviceId;
    const s = serviceState[serviceId];
    if(!s){
        return;
    }

    modalServiceName.textContent = s.info.name;
    modalServiceId.textContent = `${s.info.id} • ${s.info.health}`;

    modalStatus.textContent = (s.lastStatus === 'UP' ? 'Running' :
                               s.lastStatus === 'DEGRADED' ? 'Not certain' :
                               s.lastStatus === 'DOWN' ? 'Down' :
                               s.lastStatus);
    modalHttpCode.textContent = s.lastHttpCode;
    modalRtLast.textContent = formatMs(s.lastResponseTime);
    modalRtAvg.textContent = formatMs(s.avgResponseTime);
    modalRtP95.textContent = formatMs(s.p95ResponseTime);

    modalCpu.textContent = s.cpu != null ? s.cpu + '%' : '—';
    modalMem.textContent = s.mem != null ? s.mem + '%' : '—';
    modalUptime.textContent = formatUptime(s.uptime);

    const total = s.totalRequests || 0;
    modalTotalReq.textContent = total;
    modal2xx.textContent = s.count2xx;
    modal4xx.textContent = s.count4xx;
    modal5xx.textContent = s.count5xx;

    const errCount = s.count4xx + s.count5xx;
    const errRate = total ? (errCount / total) : 0;
    modalErrorRate.textContent = formatPercent(errRate);
    modalErrorNote.textContent = `Includes 4xx and 5xx over ${total} observed dashboard checks.`;

    const approxReqPerMin = total
        ? (total * (60000 / REFRESH_INTERVAL) / (total || 1))
        : 0;
    modalReqRate.textContent = total ? approxReqPerMin.toFixed(1) + ' / min (approx.)' : '—';

    renderResponseTimeChartForService(serviceId);

    modalOverlay.classList.remove('hidden');
}

function closeModal(){
    modalOverlay.classList.add('hidden');
    currentModalServiceId = null;
}

modalCloseBtn.addEventListener('click', closeModal);
modalOverlay.addEventListener('click', (e)=>{
    if(e.target === modalOverlay){
        closeModal();
    }
});
document.addEventListener('keydown', (e)=>{
    if(e.key === 'Escape' && !modalOverlay.classList.contains('hidden')){
        closeModal();
    }
});

// modal buttons
modalBtnLogs.addEventListener('click', ()=>{
    if(!currentModalServiceId) return;
    alert(`Logs view placeholder.\nWire this to your log platform for service: ${currentModalServiceId}.`);
});
modalBtnDeepCheck.addEventListener('click', ()=>{
    if(!currentModalServiceId) return;
    const s = serviceState[currentModalServiceId];
    alert(`Running deep health check (conceptual) for ${currentModalServiceId}.\n\nSuggested sequence:\n• Synthetic endpoint probe\n• Dependency checks (DB, queues, external APIs)\n• Cache / circuit-breaker status\n• Compare new latency vs historical p95\n\nLast observed status: ${s.lastStatus}`);
});
modalBtnJson.addEventListener('click', ()=>{
    if(!currentModalServiceId) return;
    const s = serviceState[currentModalServiceId];
    const json = s.lastMetricsJson ? JSON.stringify(s.lastMetricsJson, null, 2) : 'No /metrics payload captured yet.';
    alert(json);
});

// -------- START LOOP --------
refreshAll();
setInterval(refreshAll, REFRESH_INTERVAL);
</script>
</body>
</html>
